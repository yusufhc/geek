global
log 127.0.0.1 local1 debug

chroot /var/lib/haproxy
pidfile /var/run/haproxy.pid
user haproxy
group haproxy
daemon

defaults
log global
mode http
option dontlognull
timeout connect 10000
timeout client 300000
timeout server 300000
maxconn 60000
retries 3
balance roundrobin

frontend https_cfg
        bind 0.0.0.0:443
        mode tcp
        maxconn 300
        default_backend web_pool_https

backend web_pool_https
mode tcp


#<%= node[:opsworks][:layers][:apache][:instances][:apache7][:ip] %>
#<%= node[:opsworks][:layers][:apache][:instances].length.to_s %>

<% private_ip_array = node[:opsworks][:layers][:apache][:instances].collect{ |instance, names| names['private_ip'] } -%>
#<%= private_ip_array.length %>
#<%= private_ip_array[0] %>

<%= node[:opsworks][:layers][:apache][:instances].collect{ |instance| "server " + instance[0].to_s + " " + instance[0].to_s + ":443 check " } -%>

#server web1 web1:443 check
#server web2 web2:443 check

frontend http-cfg
        bind 0.0.0.0:80
        mode tcp
        maxconn 300
        default_backend web_pool_http

backend web_pool_http
mode tcp

<%= node[:opsworks][:layers][:apache][:instances].collect{ |instance| "server " + instance[0].to_s + " " + instance[0].to_s + ":80 check " } -%>

#server web1 web1:80 check
#server web2 web2:80 check


listen admin
    bind *:8080
    stats enable
